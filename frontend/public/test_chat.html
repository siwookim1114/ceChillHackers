<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Orchestrator Test UI</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #e6edf3;
    --muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --orange: #d29922;
    --red: #f85149;
    --purple: #bc8cff;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 24px;
  }
  h1 { font-size: 22px; margin-bottom: 4px; }
  .subtitle { color: var(--muted); font-size: 13px; margin-bottom: 20px; }
  .container { width: 100%; max-width: 840px; }

  /* Config panel */
  .config-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  .config-panel label {
    display: flex;
    flex-direction: column;
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .config-panel select, .config-panel input {
    margin-top: 4px;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 13px;
  }
  .config-panel .full-row {
    grid-column: 1 / -1;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .config-panel .full-row label {
    flex-direction: row;
    align-items: center;
    gap: 6px;
    font-size: 13px;
    text-transform: none;
    cursor: pointer;
  }

  /* Chat area */
  .chat-area {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    min-height: 400px;
    max-height: 600px;
    overflow-y: auto;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .msg {
    max-width: 85%;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.5;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .msg.user {
    align-self: flex-end;
    background: #1f6feb;
    border-bottom-right-radius: 2px;
  }
  .msg.agent {
    align-self: flex-start;
    background: #1c2128;
    border: 1px solid var(--border);
    border-bottom-left-radius: 2px;
  }
  .msg .meta {
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 4px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .msg .meta .badge {
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }
  .badge-professor { background: #1f6feb33; color: var(--accent); }
  .badge-ta_problem_gen { background: #3fb95033; color: var(--green); }
  .badge-ta_problem_solve { background: #d2992233; color: var(--orange); }
  .badge-rag { background: #bc8cff33; color: var(--purple); }
  .badge-system { background: #f8514933; color: var(--red); }
  .badge-planner, .badge-profile, .badge-results { background: #8b949e33; color: var(--muted); }
  .badge-intent { background: #30363d; color: var(--muted); }

  /* HITL panel */
  .hitl-panel {
    background: #1c2128;
    border: 2px solid var(--orange);
    border-radius: 8px;
    padding: 14px;
    margin-bottom: 12px;
    display: none;
  }
  .hitl-panel.active { display: block; }
  .hitl-panel h3 {
    font-size: 14px;
    color: var(--orange);
    margin-bottom: 8px;
  }
  .hitl-panel .hitl-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .hitl-panel textarea {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px;
    border-radius: 4px;
    font-size: 13px;
    resize: vertical;
    min-height: 50px;
    margin-top: 6px;
  }
  .hitl-panel select {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 8px;
    border-radius: 4px;
    font-size: 13px;
    margin-top: 6px;
  }

  /* Input bar */
  .input-bar {
    display: flex;
    gap: 8px;
  }
  .input-bar input {
    flex: 1;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    outline: none;
  }
  .input-bar input:focus { border-color: var(--accent); }
  .input-bar input::placeholder { color: var(--muted); }

  button {
    background: var(--accent);
    color: #fff;
    border: none;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  button:hover { opacity: 0.85; }
  button:disabled { opacity: 0.4; cursor: not-allowed; }
  button.secondary {
    background: var(--surface);
    border: 1px solid var(--border);
  }
  button.approve { background: var(--green); }
  button.reroute { background: var(--purple); }
  button.cancel-btn { background: var(--red); }

  /* Quick test buttons */
  .quick-tests {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .quick-tests button {
    font-size: 11px;
    padding: 5px 10px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    color: var(--muted);
  }
  .quick-tests button:hover { color: var(--text); border-color: var(--accent); }

  /* Citations */
  .citations-box {
    margin-top: 8px;
    padding: 8px 10px;
    background: #0d111766;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 11px;
    color: var(--muted);
  }
  .citations-box summary {
    cursor: pointer;
    font-weight: 600;
    color: var(--accent);
    font-size: 12px;
  }
  .citations-box .cite-item {
    margin-top: 4px;
    padding: 3px 0;
    border-bottom: 1px solid #30363d44;
    display: flex;
    justify-content: space-between;
  }
  .cite-item .cite-doc { color: var(--purple); }
  .cite-item .cite-page { color: var(--muted); }
  .cite-item .cite-score { color: var(--green); font-weight: 600; }
  .rag-status {
    padding: 1px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
  }
  .rag-found { background: #3fb95033; color: var(--green); }
  .rag-not-found { background: #f8514933; color: var(--red); }

  /* Status bar */
  .status-bar {
    font-size: 11px;
    color: var(--muted);
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
  }
  .status-bar .latency { color: var(--green); }

  /* Loading spinner */
  .loading {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid var(--muted);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 6px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</head>
<body>
<div class="container">
  <h1>LangGraph Orchestrator Test UI</h1>
  <p class="subtitle">Test the multi-agent routing, HITL feedback, and agent responses</p>

  <!-- Config -->
  <div class="config-panel">
    <label>API URL
      <input type="text" id="apiUrl" value="http://localhost:8000" />
    </label>
    <label>Topic
      <input type="text" id="topic" value="probability" />
    </label>
    <label>Session ID
      <input type="text" id="sessionId" value="test-session-1" />
    </label>
    <label>Level
      <select id="level">
        <option value="beginner">Beginner</option>
        <option value="intermediate" selected>Intermediate</option>
        <option value="advanced">Advanced</option>
      </select>
    </label>
    <label>Learning Style
      <select id="learningStyle">
        <option value="visual">Visual</option>
        <option value="textual">Textual</option>
        <option value="example_first">Example First</option>
        <option value="mixed" selected>Mixed</option>
      </select>
    </label>
    <label>Knowledge Mode
      <select id="knowledgeMode">
        <option value="internal_only" selected>Internal Only</option>
        <option value="external_ok">External OK</option>
        <option value="external_only">External Only</option>
      </select>
    </label>
    <div class="full-row">
      <label>
        <input type="checkbox" id="hitlEnabled" />
        Enable Human-in-the-Loop Review
      </label>
    </div>
  </div>

  <!-- Quick test queries -->
  <div class="quick-tests">
    <button onclick="quickSend('Explain Bayes theorem and its intuition')">Professor</button>
    <button onclick="quickSend('Give me 3 practice problems on derivatives')">TA Gen</button>
    <button onclick="quickSend('Check my solution: derivative of x^2 is 2x')">TA Solve</button>
    <button onclick="quickSend('Make me a study plan for the exam')">Planner (stub)</button>
    <button onclick="quickSend('Change my level to advanced')">Profile (stub)</button>
    <button onclick="quickSend('What is the meaning of life?')">General/RAG</button>
  </div>

  <!-- Chat area -->
  <div class="chat-area" id="chatArea">
    <div class="msg agent">
      <div class="meta">
        <span class="badge badge-system">system</span>
      </div>
      Ready. Type a message or click a quick-test button above.
    </div>
  </div>

  <!-- HITL panel (hidden by default) -->
  <div class="hitl-panel" id="hitlPanel">
    <h3>Human-in-the-Loop Review</h3>
    <p style="font-size:13px; color:var(--muted); margin-bottom:6px;">
      The agent produced a response. Review it and choose an action:
    </p>
    <textarea id="feedbackText" placeholder="Optional feedback text (for revise/reroute)..."></textarea>
    <label style="font-size:12px; color:var(--muted); margin-top:6px; display:block;">
      Reroute target (if rerouting):
      <select id="rerouteTo">
        <option value="">--</option>
        <option value="professor">Professor</option>
        <option value="ta_problem_gen">TA Problem Gen</option>
        <option value="ta_problem_solve">TA Problem Solve</option>
        <option value="rag">RAG</option>
      </select>
    </label>
    <div class="hitl-actions">
      <button class="approve" onclick="sendFeedback('approve')">Approve</button>
      <button class="secondary" onclick="sendFeedback('revise')">Revise</button>
      <button class="reroute" onclick="sendFeedback('reroute')">Reroute</button>
      <button class="cancel-btn" onclick="sendFeedback('cancel')">Cancel</button>
    </div>
  </div>

  <!-- Input bar -->
  <div class="input-bar">
    <input
      type="text"
      id="messageInput"
      placeholder="Type your message... (e.g., 'Explain eigenvalues')"
      onkeydown="if(event.key==='Enter')sendMessage()"
    />
    <button id="sendBtn" onclick="sendMessage()">Send</button>
  </div>

  <div class="status-bar">
    <span id="statusText">Idle</span>
    <span id="latencyText"></span>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);

// State
let lastThreadId = null;
let awaitingHitl = false;

function getConfig() {
  return {
    apiUrl: $('apiUrl').value.replace(/\/+$/, ''),
    topic: $('topic').value || 'general',
    sessionId: $('sessionId').value || 'test-' + Date.now(),
    level: $('level').value,
    learningStyle: $('learningStyle').value,
    knowledgeMode: $('knowledgeMode').value,
    hitlEnabled: $('hitlEnabled').checked,
  };
}

function addMessage(type, text, meta) {
  const chat = $('chatArea');
  const div = document.createElement('div');
  div.className = `msg ${type}`;

  if (meta) {
    const metaDiv = document.createElement('div');
    metaDiv.className = 'meta';
    if (meta.agent) {
      const badge = document.createElement('span');
      badge.className = `badge badge-${meta.agent}`;
      badge.textContent = meta.agent;
      metaDiv.appendChild(badge);
    }
    if (meta.intent) {
      const badge = document.createElement('span');
      badge.className = 'badge badge-intent';
      badge.textContent = meta.intent;
      metaDiv.appendChild(badge);
    }
    if (meta.route) {
      const badge = document.createElement('span');
      badge.className = 'badge badge-intent';
      badge.textContent = 'route: ' + meta.route;
      metaDiv.appendChild(badge);
    }
    // RAG status badge
    if (meta.ragFound !== undefined) {
      const ragBadge = document.createElement('span');
      ragBadge.className = meta.ragFound ? 'rag-status rag-found' : 'rag-status rag-not-found';
      ragBadge.textContent = meta.ragFound
        ? 'RAG: ' + (meta.ragCitationsCount || 0) + ' sources'
        : 'RAG: no KB match';
      metaDiv.appendChild(ragBadge);
    }
    if (meta.latency) {
      const span = document.createElement('span');
      span.style.color = 'var(--green)';
      span.textContent = meta.latency + 'ms';
      metaDiv.appendChild(span);
    }
    div.appendChild(metaDiv);
  }

  const textNode = document.createTextNode(text);
  div.appendChild(textNode);

  // Citations panel (collapsible)
  if (meta && meta.citations && meta.citations.length > 0) {
    const citBox = document.createElement('details');
    citBox.className = 'citations-box';
    const summary = document.createElement('summary');
    summary.textContent = 'Sources (' + meta.citations.length + ' citations from lecture docs)';
    citBox.appendChild(summary);
    meta.citations.forEach(c => {
      const item = document.createElement('div');
      item.className = 'cite-item';
      item.innerHTML =
        '<span class="cite-doc">' + (c.doc || c.title || 'unknown') + '</span>' +
        '<span class="cite-page">p.' + (c.page || '?') + '</span>' +
        '<span class="cite-score">' + (c.score !== undefined ? (c.score * 100).toFixed(1) + '%' : '') + '</span>';
      citBox.appendChild(item);
    });
    div.appendChild(citBox);
  }

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function setLoading(loading) {
  const btn = $('sendBtn');
  const input = $('messageInput');
  btn.disabled = loading;
  input.disabled = loading;
  $('statusText').innerHTML = loading
    ? '<span class="loading"></span>Waiting for response...'
    : 'Idle';
}

async function sendMessage() {
  const input = $('messageInput');
  const message = input.value.trim();
  if (!message) return;

  input.value = '';
  addMessage('user', message);
  setLoading(true);

  const cfg = getConfig();
  const startTime = Date.now();

  try {
    const res = await fetch(`${cfg.apiUrl}/api/chat`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: cfg.sessionId,
        message: message,
        topic: cfg.topic,
        level: cfg.level,
        learning_style: cfg.learningStyle,
        knowledge_mode: cfg.knowledgeMode,
        require_human_review: cfg.hitlEnabled,
      }),
    });

    const latency = Date.now() - startTime;

    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      throw new Error(err.detail || `HTTP ${res.status}`);
    }

    const data = await res.json();
    lastThreadId = cfg.sessionId;

    $('latencyText').textContent = latency + 'ms';
    $('latencyText').className = 'latency';

    // Check if graph is paused for HITL review (backend tells us)
    if (data.awaiting_feedback) {
      addMessage('agent', '[Pending Review]\n' + data.response_text, {
        agent: data.agent_name,
        intent: data.intent,
        route: data.route_used,
        latency: latency,
        ragFound: data.rag_found,
        ragCitationsCount: data.rag_citations_count,
        citations: data.citations,
      });
      awaitingHitl = true;
      $('hitlPanel').classList.add('active');
      $('statusText').innerHTML = '<span style="color:var(--orange)">Awaiting your feedback (HITL)...</span>';
      setLoading(false);
      return;
    }

    // Normal response (graph ran to completion)
    if (data.response_text && data.agent_name !== 'unknown') {
      addMessage('agent', data.response_text, {
        agent: data.agent_name,
        intent: data.intent,
        route: data.route_used,
        latency: latency,
        ragFound: data.rag_found,
        ragCitationsCount: data.rag_citations_count,
        citations: data.citations,
      });
    }

  } catch (err) {
    addMessage('agent', 'Error: ' + err.message, { agent: 'system' });
  }

  setLoading(false);
}

async function sendFeedback(action) {
  if (!awaitingHitl || !lastThreadId) return;

  const feedbackText = $('feedbackText').value.trim();
  const rerouteTo = $('rerouteTo').value || null;
  const cfg = getConfig();

  // Show feedback in chat
  const actionLabel = action === 'reroute' ? `reroute -> ${rerouteTo}` : action;
  addMessage('user', `[HITL Feedback] Action: ${actionLabel}${feedbackText ? '\n' + feedbackText : ''}`);

  // Hide HITL panel
  $('hitlPanel').classList.remove('active');
  awaitingHitl = false;
  $('feedbackText').value = '';
  $('rerouteTo').value = '';
  setLoading(true);

  const startTime = Date.now();

  try {
    const res = await fetch(`${cfg.apiUrl}/api/chat/feedback`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        session_id: cfg.sessionId,
        thread_id: lastThreadId,
        action: action,
        feedback_text: feedbackText,
        reroute_to: rerouteTo,
      }),
    });

    const latency = Date.now() - startTime;

    if (!res.ok) {
      const err = await res.json().catch(() => ({ detail: res.statusText }));
      throw new Error(err.detail || `HTTP ${res.status}`);
    }

    const data = await res.json();

    $('latencyText').textContent = latency + 'ms';

    // Check if graph paused AGAIN (e.g., revise → agent → HITL)
    if (data.awaiting_feedback) {
      addMessage('agent', '[Pending Review]\n' + data.response_text, {
        agent: data.agent_name,
        intent: data.intent,
        route: data.route_used,
        latency: latency,
        ragFound: data.rag_found,
        ragCitationsCount: data.rag_citations_count,
        citations: data.citations,
      });
      awaitingHitl = true;
      $('hitlPanel').classList.add('active');
      $('statusText').innerHTML = '<span style="color:var(--orange)">Awaiting your feedback (HITL)...</span>';
      setLoading(false);
      return;
    }

    addMessage('agent', data.response_text, {
      agent: data.agent_name,
      intent: data.intent,
      route: data.route_used,
      latency: latency,
      ragFound: data.rag_found,
      ragCitationsCount: data.rag_citations_count,
      citations: data.citations,
    });

  } catch (err) {
    addMessage('agent', 'Feedback error: ' + err.message, { agent: 'system' });
  }

  setLoading(false);
}

function quickSend(text) {
  $('messageInput').value = text;
  sendMessage();
}
</script>
</body>
</html>
